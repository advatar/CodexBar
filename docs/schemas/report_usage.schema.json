{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CodexBar Team Usage Report - report_usage request (v1)",
  "type": "object",
  "additionalProperties": false,
  "required": ["schemaVersion", "reportId", "generatedAt", "client", "snapshots"],
  "properties": {
    "schemaVersion": {
      "type": "integer",
      "const": 1
    },
    "reportId": { "$ref": "#/$defs/uuid" },
    "generatedAt": {
      "type": "string",
      "format": "date-time",
      "description": "When CodexBar generated this report (UTC ISO8601 recommended)."
    },
    "client": { "$ref": "#/$defs/client" },
    "snapshots": {
      "type": "array",
      "minItems": 1,
      "maxItems": 50,
      "items": { "$ref": "#/$defs/providerSnapshot" },
      "description": "One entry per provider snapshot in this report."
    },
    "cost": {
      "type": "array",
      "maxItems": 50,
      "items": { "$ref": "#/$defs/costPayload" },
      "description": "Optional local cost payloads (Codex/Claude), aligned with codexbar cost --format json."
    }
  },

  "$defs": {
    "uuid": {
      "type": "string",
      "pattern": "^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[1-5][0-9a-fA-F]{3}-[89abAB][0-9a-fA-F]{3}-[0-9a-fA-F]{12}$"
    },

    "client": {
      "type": "object",
      "additionalProperties": false,
      "required": ["platform", "appVersion"],
      "properties": {
        "platform": {
          "type": "string",
          "enum": ["macos", "linux", "windows", "unknown"]
        },
        "appVersion": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "description": "CodexBar app/CLI version (e.g. 0.17.0)."
        },
        "refreshCadenceSeconds": {
          "type": "integer",
          "minimum": 30,
          "maximum": 86400,
          "description": "How often CodexBar is configured to refresh/report (seconds)."
        }
      }
    },

    "providerSnapshot": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "source", "usage"],
      "properties": {
        "provider": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-zA-Z0-9][a-zA-Z0-9._-]*$",
          "description": "Provider identifier (e.g. codex, claude, cursor, gemini)."
        },
        "version": {
          "type": "string",
          "minLength": 1,
          "maxLength": 128,
          "description": "Provider version string when known (e.g. Codex CLI version)."
        },
        "source": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "description": "How data was fetched (e.g. openai-web, web, cli, oauth, api, local)."
        },
        "status": { "$ref": "#/$defs/status" },
        "usage": { "$ref": "#/$defs/usageSnapshot" },
        "credits": { "$ref": "#/$defs/credits" },
        "extras": { "$ref": "#/$defs/extras" }
      }
    },

    "status": {
      "type": "object",
      "additionalProperties": false,
      "required": ["indicator", "updatedAt"],
      "properties": {
        "indicator": {
          "type": "string",
          "enum": ["none", "minor", "major", "unknown"]
        },
        "description": {
          "type": "string",
          "maxLength": 280
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        },
        "url": {
          "type": "string",
          "format": "uri",
          "maxLength": 2048
        }
      }
    },

    "usageSnapshot": {
      "type": "object",
      "additionalProperties": false,
      "required": ["primary", "updatedAt"],
      "description": "Sanitized subset of CodexBar UsageSnapshot (NO identity/email fields allowed).",
      "properties": {
        "primary": { "$ref": "#/$defs/usageWindow" },
        "secondary": { "$ref": "#/$defs/usageWindowOrNull" },
        "tertiary": { "$ref": "#/$defs/usageWindowOrNull" },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },

    "usageWindowOrNull": {
      "anyOf": [
        { "$ref": "#/$defs/usageWindow" },
        { "type": "null" }
      ]
    },

    "usageWindow": {
      "type": "object",
      "additionalProperties": false,
      "required": ["usedPercent"],
      "properties": {
        "usedPercent": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "windowMinutes": {
          "anyOf": [
            { "type": "integer", "minimum": 1, "maximum": 525600 },
            { "type": "null" }
          ]
        },
        "resetsAt": {
          "anyOf": [
            { "type": "string", "format": "date-time" },
            { "type": "null" }
          ]
        },
        "resetDescription": {
          "anyOf": [
            { "type": "string", "maxLength": 280 },
            { "type": "null" }
          ],
          "description": "Optional human-readable reset hint; not required for analytics."
        }
      }
    },

    "credits": {
      "type": "object",
      "additionalProperties": false,
      "required": ["remaining", "updatedAt"],
      "properties": {
        "remaining": {
          "type": "number",
          "minimum": 0
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },

    "extras": {
      "type": "object",
      "additionalProperties": false,
      "description": "Allowlisted extra fields only. This is where Codex openaiDashboard-type extras go (sanitized).",
      "properties": {
        "openaiDashboard": { "$ref": "#/$defs/openaiDashboardExtras" }
      }
    },

    "openaiDashboardExtras": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "codeReviewRemainingPercent": {
          "type": "integer",
          "minimum": 0,
          "maximum": 100
        },
        "creditEvents": {
          "type": "array",
          "maxItems": 2000,
          "items": { "$ref": "#/$defs/creditEvent" }
        },
        "dailyBreakdown": {
          "type": "array",
          "maxItems": 366,
          "items": { "$ref": "#/$defs/dailyCreditBreakdown" }
        },
        "updatedAt": {
          "type": "string",
          "format": "date-time"
        }
      }
    },

    "creditEvent": {
      "type": "object",
      "additionalProperties": false,
      "required": ["id", "date", "service", "creditsUsed"],
      "properties": {
        "id": { "$ref": "#/$defs/uuid" },
        "date": { "type": "string", "format": "date-time" },
        "service": { "type": "string", "minLength": 1, "maxLength": 128 },
        "creditsUsed": { "type": "number", "minimum": 0 }
      }
    },

    "dailyCreditBreakdown": {
      "type": "object",
      "additionalProperties": false,
      "required": ["day", "services", "totalCreditsUsed"],
      "properties": {
        "day": {
          "type": "string",
          "pattern": "^\\d{4}-\\d{2}-\\d{2}$",
          "description": "YYYY-MM-DD"
        },
        "services": {
          "type": "array",
          "maxItems": 200,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["service", "creditsUsed"],
            "properties": {
              "service": { "type": "string", "minLength": 1, "maxLength": 128 },
              "creditsUsed": { "type": "number", "minimum": 0 }
            }
          }
        },
        "totalCreditsUsed": { "type": "number", "minimum": 0 }
      }
    },

    "costPayload": {
      "type": "object",
      "additionalProperties": false,
      "required": ["provider", "source", "updatedAt"],
      "properties": {
        "provider": {
          "type": "string",
          "minLength": 1,
          "maxLength": 64,
          "pattern": "^[a-zA-Z0-9][a-zA-Z0-9._-]*$"
        },
        "source": { "type": "string", "minLength": 1, "maxLength": 64 },
        "updatedAt": { "type": "string", "format": "date-time" },

        "sessionTokens": { "type": "integer", "minimum": 0 },
        "sessionCostUSD": { "type": "number", "minimum": 0 },

        "last30DaysTokens": { "type": "integer", "minimum": 0 },
        "last30DaysCostUSD": { "type": "number", "minimum": 0 },

        "daily": {
          "type": "array",
          "maxItems": 366,
          "items": { "$ref": "#/$defs/costDailyEntry" }
        },

        "totals": { "$ref": "#/$defs/costTotals" },
        "security": { "$ref": "#/$defs/costSecurity" },
        "thinking": { "$ref": "#/$defs/costThinking" },
        "modelStats": { "$ref": "#/$defs/costModelStats" }
      }
    },

    "costDailyEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": ["date", "totalTokens", "totalCost"],
      "properties": {
        "date": { "type": "string", "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },

        "inputTokens": { "type": "integer", "minimum": 0 },
        "outputTokens": { "type": "integer", "minimum": 0 },
        "cacheReadTokens": { "type": "integer", "minimum": 0 },
        "cacheCreationTokens": { "type": "integer", "minimum": 0 },
        "reasoningOutputTokens": { "type": "integer", "minimum": 0 },

        "totalTokens": { "type": "integer", "minimum": 0 },
        "totalCost": { "type": "number", "minimum": 0 },

        "modelsUsed": { "type": "integer", "minimum": 0 },
        "modelBreakdowns": {
          "type": "array",
          "maxItems": 200,
          "items": {
            "type": "object",
            "additionalProperties": false,
            "required": ["modelName", "cost"],
            "properties": {
              "modelName": { "type": "string", "minLength": 1, "maxLength": 128 },
              "cost": { "type": "number", "minimum": 0 },
              "inputTokens": { "type": "integer", "minimum": 0 },
              "outputTokens": { "type": "integer", "minimum": 0 },
              "cacheReadTokens": { "type": "integer", "minimum": 0 },
              "cacheCreationTokens": { "type": "integer", "minimum": 0 },
              "reasoningOutputTokens": { "type": "integer", "minimum": 0 },
              "totalTokens": { "type": "integer", "minimum": 0 }
            }
          }
        },
        "approvalPolicies": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "sandboxModes": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "effortLevels": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "riskySkills": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "forbiddenSkills": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        }
      }
    },

    "costTotals": {
      "type": "object",
      "additionalProperties": false,
      "required": ["totalTokens", "totalCost"],
      "properties": {
        "inputTokens": { "type": "integer", "minimum": 0 },
        "outputTokens": { "type": "integer", "minimum": 0 },
        "cacheReadTokens": { "type": "integer", "minimum": 0 },
        "cacheCreationTokens": { "type": "integer", "minimum": 0 },
        "reasoningOutputTokens": { "type": "integer", "minimum": 0 },
        "totalTokens": { "type": "integer", "minimum": 0 },
        "totalCost": { "type": "number", "minimum": 0 }
      }
    },

    "countBreakdown": {
      "type": "object",
      "additionalProperties": false,
      "required": ["name", "count"],
      "properties": {
        "name": { "type": "string", "minLength": 1, "maxLength": 128 },
        "count": { "type": "integer", "minimum": 0 }
      }
    },

    "costSecurity": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "approvalPolicies": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "sandboxModes": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "riskySkills": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        },
        "forbiddenSkills": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        }
      }
    },

    "costThinking": {
      "type": "object",
      "additionalProperties": false,
      "properties": {
        "reasoningOutputTokens": { "type": "integer", "minimum": 0 },
        "effortLevels": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/countBreakdown" }
        }
      }
    },

    "costModelStats": {
      "type": "object",
      "additionalProperties": false,
      "required": ["modelsUsed", "models"],
      "properties": {
        "modelsUsed": { "type": "integer", "minimum": 0 },
        "models": {
          "type": "array",
          "maxItems": 200,
          "items": { "$ref": "#/$defs/costModelUsage" }
        }
      }
    },

    "costModelUsage": {
      "type": "object",
      "additionalProperties": false,
      "required": ["modelName", "totalTokens", "totalCost", "activeDays"],
      "properties": {
        "modelName": { "type": "string", "minLength": 1, "maxLength": 128 },
        "inputTokens": { "type": "integer", "minimum": 0 },
        "outputTokens": { "type": "integer", "minimum": 0 },
        "cacheReadTokens": { "type": "integer", "minimum": 0 },
        "cacheCreationTokens": { "type": "integer", "minimum": 0 },
        "reasoningOutputTokens": { "type": "integer", "minimum": 0 },
        "totalTokens": { "type": "integer", "minimum": 0 },
        "totalCost": { "type": "number", "minimum": 0 },
        "activeDays": { "type": "integer", "minimum": 0 }
      }
    }
  }
}
